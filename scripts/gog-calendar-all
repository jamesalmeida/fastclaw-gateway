#!/bin/bash
# gog-calendar-all: Check events across ALL calendars for a date range
# Usage: gog-calendar-all --from <iso> --to <iso>
#
# Lists all calendars via `gog calendar calendars`, then checks each one.

set -e

FROM=""
TO=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --from) FROM="$2"; shift 2 ;;
    --to) TO="$2"; shift 2 ;;
    *) shift ;;
  esac
done

if [ -z "$FROM" ] || [ -z "$TO" ]; then
  echo "Usage: gog-calendar-all --from <iso-date> --to <iso-date>"
  echo "Example: gog-calendar-all --from 2026-02-16T00:00:00Z --to 2026-02-17T00:00:00Z"
  exit 1
fi

# Get all calendar IDs
CALENDARS=$(gog calendar calendars --plain 2>/dev/null | awk -F'\t' '{print $1}')

if [ -z "$CALENDARS" ]; then
  echo "No calendars found. Falling back to primary..."
  gog calendar events primary --from "$FROM" --to "$TO" --plain 2>/dev/null
  exit 0
fi

FOUND=false
while IFS= read -r cal_id; do
  [ -z "$cal_id" ] && continue
  OUTPUT=$(gog calendar events "$cal_id" --from "$FROM" --to "$TO" --plain 2>/dev/null || true)
  if [ -n "$OUTPUT" ] && [ "$OUTPUT" != "no events" ]; then
    FOUND=true
    echo "$OUTPUT"
  fi
done <<< "$CALENDARS"

if [ "$FOUND" = false ]; then
  echo "No events found across any calendar for this date range."
fi
